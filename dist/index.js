"use strict";var Ve=Object.create;var ge=Object.defineProperty;var Ce=Object.getOwnPropertyDescriptor;var Le=Object.getOwnPropertyNames;var Ie=Object.getPrototypeOf,Be=Object.prototype.hasOwnProperty;var Me=(s,e,t)=>e in s?ge(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var Fe=(s,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of Le(e))!Be.call(s,i)&&i!==t&&ge(s,i,{get:()=>e[i],enumerable:!(r=Ce(e,i))||r.enumerable});return s};var Se=(s,e,t)=>(t=s!=null?Ve(Ie(s)):{},Fe(e||!s||!s.__esModule?ge(t,"default",{value:s,enumerable:!0}):t,s));var Re=(s,e,t)=>(Me(s,typeof e!="symbol"?e+"":e,t),t);var ke=Se(require("fs")),Ne=Se(require("readline"));var a=class{constructor(e,t){this.start=e;this.end=t}length(){return this.start.line===this.end.line?this.end.column-this.start.column:1}sourceRange(){return this}};var P=class{constructor(e,t){this.name=e;this.value=t}accept(e){return e.visitAssignExpr(this)}sourceRange(){let e=this.name.sourceRange().start,t=this.value.sourceRange().end;return new a(e,t)}},D=class{constructor(e,t,r){this.expression=e;this.thenBranch=t;this.elseBranch=r}accept(e){return e.visitTernaryExpr(this)}sourceRange(){let e=this.expression.sourceRange().start,t=this.elseBranch.sourceRange().end;return new a(e,t)}},A=class{constructor(e,t,r){this.left=e;this.operator=t;this.right=r}accept(e){return e.visitBinaryExpr(this)}sourceRange(){let e=this.left.sourceRange().start,t=this.right.sourceRange().end;return new a(e,t)}},_=class{constructor(e,t,r,i){this.open=e;this.callee=t;this.args=r;this.close=i}accept(e){return e.visitCallExpr(this)}sourceRange(){let e=this.open.sourceRange().start,t=this.close.sourceRange().end;return new a(e,t)}},x=class{constructor(e,t,r){this.keyword=e;this.params=t;this.body=r}accept(e){return e.visitFunctionExpr(this)}sourceRange(){let{start:e}=this.keyword.sourceRange(),{end:t}=this.body.sourceRange();return new a(e,t)}},L=class{constructor(e,t){this.object=e;this.name=t}accept(e){return e.visitGetExpr(this)}sourceRange(){let e=this.object.sourceRange().start,t=this.name.sourceRange().end;return new a(e,t)}},j=class{constructor(e,t,r){this.open=e;this.expression=t;this.close=r}accept(e){return e.visitGroupingExpr(this)}sourceRange(){let e=this.open.sourceRange().start,t=this.close.sourceRange().end;return new a(e,t)}},H=class{constructor(e,t,r){this.object=e;this.name=t;this.value=r}accept(e){return e.visitSetExpr(this)}sourceRange(){let e=this.object.sourceRange().start,t=this.value.sourceRange().end;return new a(e,t)}},$=class{constructor(e){this.keyword=e}accept(e){return e.visitThisExpr(this)}sourceRange(){let e=this.keyword.sourceRange().start,t=this.keyword.sourceRange().end;return new a(e,t)}},Q=class{constructor(e,t){this.operator=e;this.right=t}accept(e){return e.visitUnaryExpr(this)}sourceRange(){let e=this.operator.sourceRange().start,t=this.right.sourceRange().end;return new a(e,t)}},q=class{constructor(e,t){this.token=e;this.value=t}accept(e){return e.visitLiteralExpr(this)}sourceRange(){let e=this.token.sourceRange().start,t=this.token.sourceRange().end;return new a(e,t)}},I=class{constructor(e,t,r){this.left=e;this.operator=t;this.right=r}accept(e){return e.visitLogicalExpr(this)}sourceRange(){let e=this.left.sourceRange().start,t=this.right.sourceRange().end;return new a(e,t)}},W=class{constructor(e){this.error=e}accept(){throw new Error("ErrorExpr should not be evaluated.")}sourceRange(){return this.error.sourceRange}},B=class{constructor(e){this.name=e}accept(e){return e.visitVariableExpr(this)}sourceRange(){let e=this.name.sourceRange().start,t=this.name.sourceRange().end;return new a(e,t)}};var K=class{constructor(e,t,r){this.open=e;this.statements=t;this.close=r}accept(e){return e.visitBlockStmt(this)}sourceRange(){let{start:e}=this.open.sourceRange(),{end:t}=this.open.sourceRange();return new a(e,t)}},Z=class{constructor(e){this.keyword=e}accept(e){return e.visitBreakStmt(this)}sourceRange(){return this.keyword.sourceRange()}},Y=class{constructor(e,t,r,i,n){this.keyword=e;this.name=t;this.open=r;this.properties=i;this.close=n}accept(e){return e.visitClassStmt(this)}sourceRange(){let{start:e}=this.keyword.sourceRange(),{end:t}=this.close.sourceRange();return new a(e,t)}},J=class{constructor(e){this.keyword=e}accept(e){return e.visitContinueStmt(this)}sourceRange(){return this.keyword.sourceRange()}},N=class{constructor(e){this.error=e}accept(){throw new Error("ErrorStmt should not be executed.")}sourceRange(){return this.error.sourceRange}},X=class{constructor(e){this.expression=e}accept(e){return e.visitExpressionStmt(this)}sourceRange(){return this.expression.sourceRange()}},ee=class{constructor(e,t,r,i){this.keyword=e;this.condition=t;this.thenBranch=r;this.elseBranch=i}accept(e){return e.visitIfStmt(this)}sourceRange(){let{start:e}=this.keyword.sourceRange();return this.elseBranch?new a(e,this.elseBranch.sourceRange().end):new a(e,this.thenBranch.sourceRange().end)}},te=class{constructor(e,t){this.keyword=e;this.value=t}accept(e){return e.visitReturnStmt(this)}sourceRange(){let{start:e}=this.keyword.sourceRange(),{end:t}=this.value.sourceRange();return new a(e,t)}},re=class{constructor(e,t){this.keyword=e;this.property=t}accept(e){return e.visitVarStmt(this)}sourceRange(){let{start:e}=this.keyword.sourceRange(),{end:t}=this.property.sourceRange();return new a(e,t)}},se=class{constructor(e,t,r,i){this.keyword=e;this.condition=t;this.increment=r;this.body=i}accept(e){return e.visitWhileStmt(this)}sourceRange(){let{start:e}=this.keyword.sourceRange(),{end:t}=this.body.sourceRange();return new a(e,t)}};var y=class{constructor(e,t){this.message=e;this.sourceRange=t}},o=class{static formatError({title:e,body:t="",type:r="error"}){return{title:`syntax ${r}: `+e,body:t,type:r}}static unterminatedString(){return this.formatError({title:"unterminated string",body:"a string must be terminated with a closing quotation mark"})}static unsupportedCharacter(){return this.formatError({title:"unsupported character",body:"this source character is not supported by the interpreter"})}static invalidAssignmentTarget(){return this.formatError({title:"invalid assignment target",body:"left-hand side of an assignment must be valid"})}static expectedIdentifier(){return this.formatError({title:"expected identifier",body:"a variable name was expected"})}static expectedParameter(){return this.formatError({title:"expected parameter",body:"a parameter name was expected"})}static expectedAssignment(){return this.formatError({title:"expected assignment",body:'an assignment operator "=" was expected'})}static expectedSemiColon(){return this.formatError({title:"expected semicolon",body:'a semicolon ";" was expected'})}static expectedColon(){return this.formatError({title:"expected colon",body:'a colon ":" was expected'})}static expectedLeftParen(){return this.formatError({title:"expected left parenthesis",body:'a left parenthesis "(" was expected'})}static expectedLeftBrace(){return this.formatError({title:"expected left brace",body:'a left brace "{" was expected'})}static expectedRightParen(){return this.formatError({title:"expected right parenthesis",body:'a right parenthesis ")" was expected'})}static expectedRightBrace(){return this.formatError({title:"expected right brace",body:'a right brace "}" was expected'})}static expectedExpression(){return this.formatError({title:"expected expression",body:"an expression was expected"})}static expectedLeftOperand(){return this.formatError({title:"expected left operand",body:"a left-hand side operand was expected"})}};var ie=class{constructor(e){this.name=e}sourceRange(){return this.name.sourceRange()}},ne=class{constructor(e,t){this.name=e;this.initializer=t}sourceRange(){let{start:e}=this.name.sourceRange(),{end:t}=this.initializer.sourceRange();return new a(e,t)}};var oe=class{tokens;errors=[];current=0;constructor(e){this.tokens=e}parse(){this.errors=[];let e=[];for(;!this.isAtEnd();)try{e.push(this.declaration())}catch(t){if(!(t instanceof N))throw t;e.push(t)}return{statements:e,errors:this.errors}}declaration(){try{return this.match("CLASS")?this.classDeclaration():this.match("VAR")?this.varDeclaration():this.statement()}catch(e){throw e instanceof y?this.errorStatement(e):e}}classDeclaration(){let e=this.previous(),t=this.consume("IDENTIFIER",o.expectedIdentifier()),r=this.consume("LEFT_BRACE",o.expectedLeftBrace()),i=[];for(;!this.check("RIGHT_BRACE")&&!this.isAtEnd();)i.push(this.property());let n=this.consume("RIGHT_BRACE",o.expectedRightBrace());return new Y(e,t,r,i,n)}varDeclaration(){return new re(this.previous(),this.property())}statement(){return this.match("RETURN")?this.returnStatement():this.match("WHILE")?this.whileStatement():this.match("IF")?this.ifStatement():this.match("LEFT_BRACE")?this.blockStatement():this.match("BREAK")?this.breakStatement():this.match("CONTINUE")?this.continueStatement():this.expressionStatement()}returnStatement(){let e=this.previous(),t=this.expression();return this.consume("SEMICOLON",o.expectedSemiColon()),new te(e,t)}whileStatement(){let e=this.previous();this.consume("LEFT_PAREN",o.expectedLeftParen());let t=this.expression(),r=this.match("SEMICOLON")?this.expression():void 0;this.consume("RIGHT_PAREN",o.expectedRightParen());let i=this.statement();return new se(e,t,r,i)}ifStatement(){let e=this.previous();this.consume("LEFT_PAREN",o.expectedLeftParen());let t=this.expression();this.consume("RIGHT_PAREN",o.expectedRightParen());let r=this.statement(),i=this.match("ELSE")?this.statement():void 0;return new ee(e,t,r,i)}breakStatement(){let e=this.previous();return this.consume("SEMICOLON",o.expectedSemiColon()),new Z(e)}continueStatement(){let e=this.previous();return this.consume("SEMICOLON",o.expectedSemiColon()),new J(e)}blockStatement(){let e=this.previous(),t=[];for(;!this.check("RIGHT_BRACE")&&!this.isAtEnd();)t.push(this.declaration());let r=this.consume("RIGHT_BRACE",o.expectedRightBrace());return new K(e,t,r)}expressionStatement(){let e=this.expression();return this.consume("SEMICOLON",o.expectedSemiColon()),new X(e)}expression(){return this.assignment()}assignment(){let e=this.ternary();if(this.match("EQUAL")){let t=this.assignment();if(e instanceof B)return new P(e.name,t);if(e instanceof L)return new H(e.object,e.name,t);this.error(e,o.invalidAssignmentTarget())}return e}ternary(){let e=this.or();if(this.match("QUESTION")){let t=this.ternary();this.consume("COLON",o.expectedColon());let r=this.ternary();e=new D(e,t,r)}return e}or(){let e=this.and();for(;this.match("OR");){let t=this.previous(),r=this.and();e=new I(e,t,r)}return e}and(){let e=this.equality();for(;this.match("AND");){let t=this.previous(),r=this.equality();e=new I(e,t,r)}return e}equality(){let e=this.comparison();for(;this.match("BANG_EQUAL","EQUAL_EQUAL");){let t=this.previous(),r=this.comparison();e=new A(e,t,r)}return e}comparison(){let e=this.term();for(;this.match("GREATER","GREATER_EQUAL","LESS","LESS_EQUAL");){let t=this.previous(),r=this.term();e=new A(e,t,r)}return e}term(){let e=this.factor();for(;this.match("MINUS","PLUS","HASH");){let t=this.previous(),r=this.factor();e=new A(e,t,r)}return e}factor(){let e=this.unary();for(;this.match("SLASH","STAR");){let t=this.previous(),r=this.unary();e=new A(e,t,r)}return e}unary(){if(this.match("BANG","MINUS")){let e=this.previous(),t=this.unary();return new Q(e,t)}return this.call()}call(){let e=this.primary();for(;;)if(this.match("LEFT_PAREN")){let t=this.previous(),r=this.arguments(),i=this.consume("RIGHT_PAREN",o.expectedRightParen());e=new _(t,e,r,i)}else if(this.match("DOT")){let t=this.consume("IDENTIFIER",o.expectedIdentifier());e=new L(e,t)}else break;return e}primary(){if(this.match("NUMBER","STRING","FALSE","TRUE","NULL")){let e=this.previous();return new q(e,e.literal)}if(this.match("THIS"))return new $(this.previous());if(this.match("IDENTIFIER"))return new B(this.previous());if(this.match("FUNCTION"))return this.func();if(this.match("LEFT_PAREN")){let e=this.previous(),t=this.expression(),r=this.consume("RIGHT_PAREN",o.expectedRightParen());return new j(e,t,r)}return this.errorExpression()}func(){let e=this.previous();this.consume("LEFT_PAREN",o.expectedLeftParen());let t=this.parameters();this.consume("RIGHT_PAREN",o.expectedRightParen()),this.consume("LEFT_BRACE",o.expectedLeftBrace());let r=this.blockStatement();return new x(e,t,r)}errorStatement(e){for(this.advance();!this.isAtEnd();){switch(this.peek().type){case"BREAK":case"CONTINUE":case"CLASS":case"VAR":case"FOR":case"IF":case"WHILE":case"RETURN":return new N(e)}this.advance()}return new N(e)}errorExpression(){let e=[[["OR"],this.or.bind(this)],[["AND"],this.and.bind(this)],[["BANG_EQUAL","EQUAL_EQUAL"],this.equality.bind(this)],[["GREATER","GREATER_EQUAL","LESS","LESS_EQUAL"],this.comparison.bind(this)],[["PLUS","HASH"],this.term.bind(this)],[["SLASH","STAR"],this.comparison.bind(this)]];for(let[t,r]of e)if(this.match(...t)){let i=new W(this.error(this.previous(),o.expectedLeftOperand()));return r(),i}throw this.error(this.peek(),o.expectedExpression())}arguments(){let e=[];if(!this.check("RIGHT_PAREN"))do e.push(this.expression());while(this.match("COMMA"));return e}parameters(){let e=[];if(!this.check("RIGHT_PAREN"))do e.push(this.parameter());while(this.match("COMMA"));return e}parameter(){let e=this.consume("IDENTIFIER",o.expectedParameter());return new ie(e)}property(){let e=this.consume("IDENTIFIER",o.expectedIdentifier());this.consume("EQUAL",o.expectedAssignment());let t=this.expression();return t instanceof x||this.consume("SEMICOLON",o.expectedSemiColon()),new ne(e,t)}match(...e){for(let t of e)if(this.check(t))return this.advance(),!0;return!1}consume(e,t){if(this.check(e))return this.advance();throw this.error(this.peek(),t)}check(e){return this.isAtEnd()?!1:this.peek().type===e}advance(){return this.isAtEnd()||(this.current+=1),this.previous()}isAtEnd(){return this.peek().type==="EOF"}peek(){return this.tokens[this.current]}previous(){return this.tokens[this.current-1]}error(e,t){let r=new y(t,e.sourceRange());return this.errors.push(r),r}};var ae=class{constructor(e,t,r,i,n){this.type=e;this.lexeme=t;this.literal=r;this.line=i;this.column=n}toString(){return`${this.type} ${this.lexeme} ${this.literal}`}sourceRange(){let e={line:this.line,column:this.column},t={line:this.line,column:this.column+this.lexeme.length};return new a(e,t)}};var Ae=s=>xe(s)||V(s),xe=s=>s>="a"&&s<="z"||s>="A"&&s<="Z"||s=="_",V=s=>s>="0"&&s<="9";var we=new Map([["and","AND"],["break","BREAK"],["continue","CONTINUE"],["class","CLASS"],["else","ELSE"],["for","FOR"],["f","FUNCTION"],["if","IF"],["or","OR"],["return","RETURN"],["super","SUPER"],["this","THIS"],["type","TYPE"],["var","VAR"],["while","WHILE"]]);var f=class{constructor(e,t){this.message=e;this.sourceRange=t}},u=class{static formatError({title:e,body:t="",type:r="error"}){return{title:`runtime ${r}: `+e,body:t,type:r}}static undefinedVariable(e){return this.formatError({title:"undefined variable",body:`the variable "${e}" was used before it was defined`})}static unresolvedVariable(e,t){return this.formatError({title:"unresolved variable",body:`unable to find variable "${e}" at environment distance ${t}`})}static prohibitedZeroDivision(){return this.formatError({title:"prohibited division by zero",body:"prohibited attempt to divide by zero"})}static mismatchedArity(e,t){return this.formatError({title:"mismatched arity",body:`expected ${e} arguments but got ${t}`})}static unexpectedBinaryOperator(){return this.formatError({title:"unexpected binary operator",body:""})}static unexpectedUnaryOperator(){return this.formatError({title:"unexpected unary operator",body:""})}static unexpectedLogicalOperator(){return this.formatError({title:"unexpected logical operator",body:""})}static expectedString(){return this.formatError({title:"expected string",body:"a string was expected"})}static expectedNumber(){return this.formatError({title:"expected number",body:"a number was expected"})}static expectedBoolean(){return this.formatError({title:"expected boolean",body:"a boolean was expected"})}static expectedCallable(){return this.formatError({title:"expected callable",body:"a function or class was expected"})}static undefinedProperty(e){return this.formatError({title:"undefined property",body:`property ${e} is undefined`})}static unassignablePropertyTarget(e){return this.formatError({title:"unassignable property target",body:`unable to assign properties to "${e}"`})}};var l=class{methods=new Map;fields=new Map;constructor(e={}){for(let[t,r]of Object.entries(e))r.type==="FUNCTION"||r.type==="NATIVE_FUNCTION"?this.methods.set(t,r):this.fields.set(t,r)}get(e){let t=this.fields.get(e.lexeme);if(t)return t;let r=this.methods.get(e.lexeme);if(r)return r.bind(this);throw this.error(e,u.undefinedProperty(e.lexeme))}set(e,t){throw this.error(e,u.unassignablePropertyTarget(this.toString()))}error(e,t){return new f(t,e.sourceRange())}};var T=class extends l{constructor(t){super();this.jsFunction=t}type="NATIVE_FUNCTION";className="NativeFunction";arity(){return this.jsFunction.length}bind(t){return new T(this.jsFunction.bind(t))}call(t,r){return this.jsFunction(...r)}toString(){return"<native fn>"}},p=s=>{let e={};for(let[t,r]of Object.entries(s))e[t]=new T(r);return e};var c=class extends l{constructor(t){super({...p({toString:()=>new c(this.toString())})});this.value=t}type="STRING";toString(){return this.value}};var m=class extends l{constructor(t){super({...p({toString:()=>new c(this.toString())})});this.value=t}type="NUMBER";toString(){return String(this.value)}};var b=class extends l{constructor(t=null){super({...p({toString:()=>new c(this.toString())})});this.value=t}type="NULL";toString(){return String(this.value)}};var d=class extends l{constructor(t=!0){super({...p({toString:()=>new c(this.toString())})});this.value=t}type="TRUE";toString(){return String(this.value)}};var E=class extends l{constructor(t=!1){super({...p({toString:()=>new c(this.toString())})});this.value=t}type="FALSE";toString(){return String(this.value)}};var ce=class{source;tokens=[];start=0;current=0;line=1;lineStart=0;errors=[];constructor(e){this.source=e}scan(){try{for(this.errors=[];!this.isAtEnd();)this.start=this.current,this.scanToken();return this.start=this.current,this.addToken("EOF",{text:"\0"}),{tokens:this.tokens,errors:this.errors}}catch(e){if(e instanceof y)return{tokens:[],errors:this.errors};throw e}}scanToken(){let e=this.advance();switch(e){case"(":this.addToken("LEFT_PAREN");break;case")":this.addToken("RIGHT_PAREN");break;case"{":this.addToken("LEFT_BRACE");break;case"}":this.addToken("RIGHT_BRACE");break;case",":this.addToken("COMMA");break;case".":this.addToken("DOT");break;case"-":this.addToken("MINUS");break;case"+":this.addToken("PLUS");break;case";":this.addToken("SEMICOLON");break;case"*":this.addToken("STAR");break;case"?":this.addToken("QUESTION");break;case"#":this.addToken("HASH");break;case":":this.addToken("COLON");break;case"!":this.addToken(this.match("=")?"BANG_EQUAL":"BANG");break;case"=":this.addToken(this.match("=")?"EQUAL_EQUAL":"EQUAL");break;case"<":this.addToken(this.match("=")?"LESS_EQUAL":"LESS");break;case">":this.addToken(this.match("=")?"GREATER_EQUAL":"GREATER");break;case"/":this.match("/")?this.lineComment():this.match("*")?this.blockComment():this.addToken("SLASH");break;case" ":case"\r":case"	":case`
`:break;case'"':case"'":this.string(e);break;default:V(e)?this.number():xe(e)?this.primitives():this.error(o.unsupportedCharacter())}}blockComment(){for(;!this.isAtEnd()&&!(this.match("*")&&this.match("/"));)this.advance()}lineComment(){for(;this.peek()!==`
`&&!this.isAtEnd();)this.advance()}primitives(){for(;Ae(this.peek());)this.advance();let e=this.source.substring(this.start,this.current);switch(e){case"null":this.addToken("NULL",{literal:new b});break;case"true":this.addToken("TRUE",{literal:new d});break;case"false":this.addToken("FALSE",{literal:new E});break;default:this.addToken(we.get(e)||"IDENTIFIER")}}string(e){for(;this.peek()!==e&&!this.isAtEnd();)this.advance();if(this.isAtEnd())return this.error(o.unterminatedString());this.advance();let t=this.source.substring(this.start+1,this.current-1);this.addToken("STRING",{literal:new c(t)})}number(){for(;V(this.peek());)this.advance();if(this.peek()==="."&&V(this.peekNext()))for(this.advance();V(this.peek());)this.advance();let e=parseFloat(this.source.substring(this.start,this.current));this.addToken("NUMBER",{literal:new m(e)})}match(e){return this.peek()!==e?!1:(this.advance(),!0)}peekNext(){return this.current+1>=this.source.length?"\0":this.source.charAt(this.current+1)}peek(){return this.isAtEnd()?"\0":this.source.charAt(this.current)}advance(){let e=this.source.charAt(this.current);return this.current+=1,e===`
`&&(this.line+=1,this.lineStart=this.current),e}addToken(e,{literal:t,text:r=this.source.substring(this.start,this.current)}={}){let i=1+this.start-this.lineStart;this.tokens.push(new ae(e,r,t,this.line,i))}isAtEnd(){return this.current>=this.source.length}error(e){let t=this.line,r=this.current-this.lineStart,i=new a({line:t,column:r},{line:t,column:r+1});this.errors.push(new y(e,i))}};var fe=(s,e)=>s.type==="NULL"&&e.type==="NULL"||s.type==="STRING"&&e.type==="STRING"||s.type==="NUMBER"&&e.type==="NUMBER"||s.type==="TRUE"&&e.type==="TRUE"||s.type==="FALSE"&&e.type==="FALSE"?s.value===e.value:s===e;var S=class{values=new Map;enclosing;constructor(e){this.enclosing=e}static fromGlobals(e){let t=new S;for(let[r,i]of Object.entries(e))t.define(r,i);return t}get(e){let t=this.values.get(e.lexeme);if(t)return t;if(this.enclosing)return this.enclosing.get(e);throw this.error(e,u.undefinedVariable(e.lexeme))}getAt(e,t,r){let i=this.ancestor(t).values.get(e);if(i===void 0){let n=u.unresolvedVariable(e,t);throw r?this.error(r,n):new Error(`${n.title}: ${n.body}`)}return i}assign(e,t){if(this.values.has(e.lexeme))this.values.set(e.lexeme,t);else if(this.enclosing)this.enclosing.assign(e,t);else throw this.error(e,u.undefinedVariable(e.lexeme))}assignAt(e,t,r){this.ancestor(e).values.set(t.lexeme,r)}define(e,t){this.values.set(e,t)}ancestor(e){let t=this;for(let r=0;r<e&&t.enclosing;r++)t=t.enclosing;return t}error(e,t){return new f(t,e.sourceRange())}};var Oe=new T(()=>new m(Date.now()/1e3)),Ue=new T(s=>{let e=s.toString();return console.log(e),new c(e)}),le={clock:Oe,print:Ue};var C=class{constructor(e){this.value=e;this.value=e}},M=class{},F=class{};var w=class extends l{constructor(t,r,i){super({...p({toString:()=>new c(this.toString())})});this.expression=t;this.closure=r;this.isInitializer=i}type="FUNCTION";arity(){return this.expression.params.length}bind(t){let r=new S(this.closure);return r.define("this",t),new w(this.expression,r,this.isInitializer)}call(t,r){let i=new S(this.closure);for(let[n,h]of this.expression.params.entries())i.define(h.name.lexeme,r[n]);try{t.interpretBlock(this.expression.body.statements,i)}catch(n){if(n instanceof C)return n.value;throw n}return this.isInitializer?this.closure.getAt("this",0):new b}toString(){return"<fn>"}};var O=class extends l{constructor(t,r){super({...p({toString:()=>new c(this.toString())})});this.atlasClass=t;this.fields=r}type="INSTANCE";get(t){let r=this.fields.get(t.lexeme);if(r)return r;let i=this.atlasClass.findMethod(t.lexeme);return i?i.bind(this):super.get(t)}set(t,r){this.fields.set(t.lexeme,r)}toString(){return`${this.atlasClass.name} instance`}};Re(O,"atlasClass");var ue=class extends l{constructor(t,r={}){super({...p({toString:()=>new c(this.toString())}),...r});this.name=t}type="CLASS";arity(){var t;return((t=this.findMethod("init"))==null?void 0:t.arity())||0}bind(){return this}call(t,r){var n;let i=new O(this,this.fields);return(n=this.findMethod("init"))==null||n.bind(i).call(t,r),i}findMethod(t){return this.methods.get(t)}toString(){return this.name}};var pe=class{globals=S.fromGlobals(le);environment=this.globals;locals=new Map;interpret(e){try{for(let t of e)this.execute(t);return{errors:[]}}catch(t){if(t instanceof f)return{errors:[t]};throw t}}evaluate(e){return e.accept(this)}execute(e){e.accept(this)}resolve(e,t){this.locals.set(e,t)}interpretBlock(e,t){let r=this.environment;try{this.environment=t;for(let i of e)this.execute(i)}finally{this.environment=r}}visitBlockStmt(e){this.interpretBlock(e.statements,new S(this.environment))}visitClassStmt(e){this.environment.define(e.name.lexeme,new b);let t={};for(let{name:i,initializer:n}of e.properties){let h=n instanceof x?new w(n,this.environment,i.lexeme==="init"):this.evaluate(n);t[i.lexeme]=h}let r=new ue(e.name.lexeme,t);this.environment.assign(e.name,r)}visitBreakStmt(){throw new M}visitContinueStmt(){throw new F}visitExpressionStmt(e){this.evaluate(e.expression)}visitVarStmt(e){let t=this.evaluate(e.property.initializer);this.environment.define(e.property.name.lexeme,t)}visitWhileStmt(e){for(;this.getBooleanValue(e.condition,this.evaluate(e.condition));)try{this.execute(e.body),e.increment&&this.evaluate(e.increment)}catch(t){if(t instanceof M)break;if(t instanceof F){e.increment&&this.evaluate(e.increment);continue}throw t}}visitReturnStmt(e){let t=this.evaluate(e.value);throw new C(t)}visitIfStmt(e){this.getBooleanValue(e.condition,this.evaluate(e.condition))?this.execute(e.thenBranch):e.elseBranch&&this.execute(e.elseBranch)}visitAssignExpr(e){let t=this.evaluate(e.value),r=this.locals.get(e);return r!==void 0?this.environment.assignAt(r,e.name,t):this.globals.assign(e.name,t),t}visitTernaryExpr(e){return this.getBooleanValue(e.expression,this.evaluate(e.expression))?this.evaluate(e.thenBranch):this.evaluate(e.elseBranch)}visitBinaryExpr(e){let t=e.left,r=e.right,i=this.evaluate(e.left),n=this.evaluate(e.right);switch(e.operator.type){case"HASH":return new c(this.getStringValue(t,i)+this.getStringValue(r,n));case"PLUS":return new m(this.getNumberValue(t,i)+this.getNumberValue(r,n));case"MINUS":return new m(this.getNumberValue(t,i)-this.getNumberValue(r,n));case"SLASH":let h=this.getNumberValue(t,i),R=this.getNumberValue(r,n);if(R===0)throw this.error(r,u.prohibitedZeroDivision());return new m(h/R);case"STAR":return new m(this.getNumberValue(t,i)*this.getNumberValue(r,n));case"GREATER":return this.getNumberValue(t,i)>this.getNumberValue(r,n)?new d:new E;case"GREATER_EQUAL":return this.getNumberValue(t,i)>=this.getNumberValue(r,n)?new d:new E;case"LESS":return this.getNumberValue(t,i)<this.getNumberValue(r,n)?new d:new E;case"LESS_EQUAL":return this.getNumberValue(t,i)<=this.getNumberValue(r,n)?new d:new E;case"BANG_EQUAL":return!fe(i,n)?new d:new E;case"EQUAL_EQUAL":return fe(i,n)?new d:new E;default:throw this.error(e.operator,u.unexpectedBinaryOperator())}}visitGroupingExpr(e){return this.evaluate(e.expression)}visitUnaryExpr(e){let t=e.right,r=this.evaluate(e.right);switch(e.operator.type){case"BANG":return this.getBooleanValue(t,r)?new E:new d;case"MINUS":return new m(-this.getNumberValue(t,r));default:throw this.error(e.operator,u.unexpectedUnaryOperator())}}visitCallExpr(e){let t=this.getCallable(e.callee,this.evaluate(e.callee)),r=e.args.map(i=>this.evaluate(i));if(t.arity()!==r.length)throw this.error(e.close,u.mismatchedArity(t.arity(),r.length));return t.call(this,r)}visitGetExpr(e){return this.evaluate(e.object).get(e.name)}visitFunctionExpr(e){return new w(e,this.environment,!1)}visitLiteralExpr(e){return e.value}visitLogicalExpr(e){let t=this.evaluate(e.left);switch(e.operator.type){case"OR":if(this.getBooleanValue(e.left,t))return t;break;case"AND":if(!this.getBooleanValue(e.left,t))return t;break;default:throw this.error(e.operator,u.unexpectedLogicalOperator())}return this.evaluate(e.right)}visitSetExpr(e){let t=this.evaluate(e.object),r=this.evaluate(e.value);return t.set(e.name,r),r}visitThisExpr(e){return this.lookupVariable(e.keyword,e)}visitVariableExpr(e){return this.lookupVariable(e.name,e)}lookupVariable(e,t){let r=this.locals.get(t);return r!==void 0?this.environment.getAt(e.lexeme,r,e):this.globals.get(e)}getStringValue(e,t){if(t.type==="STRING")return t.value;throw this.error(e,u.expectedString())}getNumberValue(e,t){if(t.type==="NUMBER")return t.value;throw this.error(e,u.expectedNumber())}getBooleanValue(e,t){if(t.type==="TRUE"||t.type==="FALSE")return t.value;throw this.error(e,u.expectedBoolean())}getCallable(e,t){if(t.type==="CLASS"||t.type==="FUNCTION"||t.type==="NATIVE_FUNCTION")return t;throw this.error(e,u.expectedCallable())}error(e,t){return new f(t,e.sourceRange())}};var he=class{constructor(e,t){this.message=e;this.sourceRange=t}},g=class{static formatError({title:e,body:t="",type:r="error"}){return{title:`semantic ${r}: `+e,body:t,type:r}}static unusedVariable(){return this.formatError({title:"unused variable",body:"variable was defined but never used",type:"warning"})}static prohibitedVariableInitializer(){return this.formatError({title:"prohbited variable initializer",body:"variable cannot reference the variable being initialized"})}static prohibitedRedeclaration(){return this.formatError({title:"prohibited variable redeclaration",body:"existing variable cannot be redeclared"})}static prohibitedFunctionReturn(){return this.formatError({title:"prohibited function return",body:"return statement cannot be used outside of a function"})}static prohibitedInitReturn(){return this.formatError({title:"prohibited initializer return",body:"return statement cannot be used inside of an init method"})}static prohibitedBreak(){return this.formatError({title:"prohibited break",body:"break statement was used outside of the context of a loop"})}static prohibitedContinue(){return this.formatError({title:"prohibited continue",body:"continue statement was used outside of the context of a loop"})}static prohibitedThis(){return this.formatError({title:"prohibited this",body:"this expression was used outside of the context of a class"})}};var k=class{storage=new Map;static fromGlobals(e,t){let r=new k;for(let[i,n]of Object.entries(e))r.storage.set(i,t(i,n));return r}has(e){return this.storage.has(e)}get(e){return this.storage.get(e)}set(e,t){this.storage.set(e,t)}values(){return this.storage.values()}};var me=class{storage=[];constructor(...e){e.forEach(t=>this.push(t))}push(e){this.storage.push(e)}pop(){return this.storage.pop()}peek(){return this.storage[this.size-1]}get(e){return this.storage[e]}get size(){return this.storage.length}[Symbol.iterator](){let e=this.size,t=this.storage;return{next:()=>({value:t[--e],done:e<0})}}};var de=class{constructor(e,t){this.interpreter=e;this.statements=t}scopes=new me;currentFunction="NONE";currentClass="NONE";loopDepth=0;errors=[];analyze(){this.beginScope(k.fromGlobals(le,()=>({state:"SETTLED"})));for(let e of this.statements)this.analyzeStmt(e);return this.endScope(),{errors:this.errors}}analyzeStmt(e){e.accept(this)}analyzeExpr(e){e.accept(this)}analyzeFunction(e,t){let r=this.currentFunction;this.currentFunction=t,this.beginScope();for(let i of e.params)this.declare(i.name),this.define(i.name);this.analyzeBlock(e.body.statements),this.endScope(),this.currentFunction=r}analyzeProperty(e,t){e.initializer instanceof x?(this.declare(e.name),this.define(e.name),this.analyzeFunction(e.initializer,t)):(this.declare(e.name),this.analyzeExpr(e.initializer),this.define(e.name))}analyzeLocal(e,t,r){for(let i=this.scopes.size-1;i>=0;i--){let n=this.scopes.get(i);if(n&&n.has(t.lexeme)){let h=n.get(t.lexeme);return r&&h&&(h.state="SETTLED"),this.interpreter.resolve(e,this.scopes.size-1-i)}}}analyzeBlock(e){for(let t of e)this.analyzeStmt(t)}visitBlockStmt(e){this.beginScope(),this.analyzeBlock(e.statements),this.endScope()}visitClassStmt(e){let t=this.currentClass;this.currentClass="CLASS",this.declare(e.name),this.define(e.name),this.beginScope(),this.getScope().set("this",{state:"SETTLED"});for(let r of e.properties){let n=r.name.lexeme==="init"?"INIT":"METHOD";this.analyzeProperty(r,n)}this.endScope(),this.currentClass=t}visitBreakStmt(e){this.loopDepth===0&&this.error(e.keyword,g.prohibitedBreak())}visitContinueStmt(e){this.loopDepth===0&&this.error(e.keyword,g.prohibitedContinue())}visitExpressionStmt(e){this.analyzeExpr(e.expression)}visitIfStmt(e){this.analyzeExpr(e.condition),this.analyzeStmt(e.thenBranch),e.elseBranch&&this.analyzeStmt(e.elseBranch)}visitReturnStmt(e){switch(this.currentFunction){case"NONE":this.error(e.keyword,g.prohibitedFunctionReturn());break;case"INIT":this.error(e.keyword,g.prohibitedInitReturn());break}this.analyzeExpr(e.value)}visitVarStmt(e){this.analyzeProperty(e.property,"FUNCTION")}visitWhileStmt(e){this.analyzeExpr(e.condition),e.increment&&this.analyzeExpr(e.increment),this.loopDepth++,this.analyzeStmt(e.body),this.loopDepth--}visitAssignExpr(e){this.analyzeExpr(e.value),this.analyzeLocal(e,e.name,!1)}visitBinaryExpr(e){this.analyzeExpr(e.left),this.analyzeExpr(e.right)}visitCallExpr(e){this.analyzeExpr(e.callee);for(let t of e.args)this.analyzeExpr(t)}visitGetExpr(e){this.analyzeExpr(e.object)}visitGroupingExpr(e){this.analyzeExpr(e.expression)}visitFunctionExpr(e){this.analyzeFunction(e,"FUNCTION")}visitLiteralExpr(){}visitLogicalExpr(e){this.analyzeExpr(e.left),this.analyzeExpr(e.right)}visitSetExpr(e){this.analyzeExpr(e.value),this.analyzeExpr(e.object)}visitThisExpr(e){this.currentClass==="NONE"&&this.error(e.keyword,g.prohibitedThis()),this.analyzeLocal(e,e.keyword,!0)}visitTernaryExpr(e){this.analyzeExpr(e.expression),this.analyzeExpr(e.thenBranch),this.analyzeExpr(e.elseBranch)}visitUnaryExpr(e){this.analyzeExpr(e.right)}visitVariableExpr(e){var r;let t=this.scopes.peek();t&&((r=t.get(e.name.lexeme))==null?void 0:r.state)==="DECLARED"&&this.error(e,g.prohibitedVariableInitializer()),this.analyzeLocal(e,e.name,!0)}beginScope(e=new k){this.scopes.push(e)}endScope(){let e=this.scopes.pop();if(e&&this.currentClass==="NONE")for(let{state:t,source:r}of e.values())t==="DEFINED"&&r&&this.error(r,g.unusedVariable())}declare(e){let t=this.getScope();t.has(e.lexeme)&&this.error(e,g.prohibitedRedeclaration()),t.set(e.lexeme,{state:"DECLARED",source:e})}define(e){this.getScope().set(e.lexeme,{state:"DEFINED",source:e})}getScope(){let e=this.scopes.peek();if(!e)throw new Error("Expected scope");return e}error(e,t){let r=new he(t,e.sourceRange());return this.errors.push(r),r}};var U=class{reporter;interpreter=new pe;constructor({reporter:e}){this.reporter=e}run(e){let{status:t,statements:r}=this.check(e);if(t!=="VALID")return t;let{errors:i}=this.interpreter.interpret(r);return i.length?(i.forEach(n=>this.reporter.rangeError(e,n.sourceRange,n.message)),"RUNTIME_ERROR"):"SUCCESS"}check(e){let t=new ce(e),{tokens:r,errors:i}=t.scan();if(this.reportErrors(e,i))return{status:"STATIC_ERROR",statements:[]};let n=new oe(r),{statements:h,errors:R}=n.parse();if(this.reportErrors(e,R))return{status:"STATIC_ERROR",statements:[]};let v=new de(this.interpreter,h),{errors:G}=v.analyze();return this.reportErrors(e,G)?{status:"STATIC_ERROR",statements:[]}:{status:"VALID",statements:h}}reportErrors(e,t){let r=!1;return t.forEach(({message:i,sourceRange:n})=>{i.type==="error"&&(r=!0),this.reporter.rangeError(e,n,i)}),r}};var Ee=Se(require("chalk")),z=class{log(e){console.log(e)}rangeError(e,t,{title:r,body:i,type:n}){let R=n==="error"?Ee.default.red:Ee.default.yellow,{start:v}=t,G=e.split(`
`)[v.line-1].replace(/\t/g," "),ve=Array(6+v.column-1).fill(" ").join("")+Array(t.length()).fill("^").join(""),ye=R(`${v.line}:${v.column} | `),Te=`${v.line.toString().padEnd(6)}`,be=`${ye}${R(r)}

${Te}${G}
`+Ee.default.blue(`${ve} ${i}
`);this.error(be)}error(e){console.error(e)}};function Ge(s){s.length>1?(console.log("Usage: atlas [script]"),process.exit(64)):s.length==1?Pe(s[0]):De()}function Pe(s){let e=new z,t;try{t=ke.default.readFileSync(s,{encoding:"utf8"})}catch{e.error(`Unable to open file: ${s}`),process.exit(66)}switch(new U({reporter:e}).run(t)){case"STATIC_ERROR":return process.exit(65);case"RUNTIME_ERROR":return process.exit(70);case"SUCCESS":return process.exit(0)}}function De(){let s=new U({reporter:new z}),e=Ne.default.createInterface({input:process.stdin,output:process.stdout});e.setPrompt("> "),e.prompt(),e.on("line",t=>{s.run(t),e.prompt()})}Ge(process.argv.slice(2));
